#!/usr/bin/env python3
"""
Semgrep Vulnerability Scoring Engine
Calculates CVSS-style scores for RAG-specific vulnerabilities
"""

import json
from enum import Enum
from typing import Dict, List
from dataclimport dataclass

class AttackVector(Enum):
    NETWORK = ("N", 0.85)
    ADJACENT = ("A", 0.62)
    LOCAL = ("L", 0.55)
    PHYSICAL = ("P", 0.20)

class AttackComplexity(Enum):
    LOW = ("L", 0.77)
    HIGH = ("H", 0.44)

class PrivilegesRequired(Enum):
    NONE = ("N", 0.85)
    LOW = ("L", 0.62)
    HIGH = ("H", 0.27)

class UserInteraction(Enum):
    NONE = ("N", 0.85)
    REQUIRED = ("R", 0.62)

class Scope(Enum):
    UNCHANGED = ("U", 0.0)
    CHANGED = ("C", 0.0)

class Impact(Enum):
    NONE = ("N", 0.0)
    LOW = ("L", 0.22)
    HIGH = ("H", 0.56)

@dataclass
class VulnerabilityScore:
    """CVSS-style vulnerability score"""
    attack_vector: AttackVector
    attack_complexity: AttackComplexity
    privileges_required: PrivilegesRequired
    user_interaction: UserInteraction
    scope: Scope
    confidentiality: Impact
    integrity: Impact
    availability: Impact
    
    def calculate_base_score(self) -> float:
        """Calculate CVSS base score (0-10)"""
        # Impact Sub-Score
        isc_base = 1 - ((1 - self.confidentiality.value[1]) * 
                       (1 - self.integrity.value[1]) * 
                       (1 - self.availability.value[1]))
        
        if self.scope == Scope.UNCHANGED:
            impact = 6.42 * isc_base
        else:
            impact = 7.52 * (isc_base - 0.029) - 3.25 * pow(isc_base - 0.02, 15)
        
        # Exploitability Sub-Score
        exploitability = (8.22 * 
                         self.attack_vector.value[1] * 
                         self.attack_complexity.value[1] * 
                         self.privileges_required.value[1] * 
                         self.user_interaction.value[1])
        
        # Base Score
        if impact <= 0:
            return 0.0
        
        if self.scope == Scope.UNCHANGED:
            base_score = min(impact + exploitability, 10.0)
        else:
            base_score = min(1.08 * (impact + exploitability), 10.0)
        
        return round(base_score, 1)
    
    def get_severity(self) -> str:
        """Get severity rating"""
        score = self.calculate_base_score()
        if score == 0.0:
            return "NONE"
        elif score < 4.0:
            return "LOW"
        elif score < 7.0:
            return "MEDIUM"
        elif score < 9.0:
            return "HIGH"
        else:
            return "CRITICAL"

class RAGVulnerabilityScorer:
    """RAG-specific vulnerability scoring"""
    
    # RAG-specific severity multipliers
    RAG_MULTIPLIERS = {
        "label_inversion": 1.2,
        "embedding_attractor": 1.3,
        "provenance_spoofing": 1.1,
        "credential_leakage": 1.5,
        "context_injection": 1.2,
    }
    
    def score_vulnerability(self, vuln_type: str, detected_patterns: List[str]) -> Dict:
        """Score a RAG vulnerability"""
        # Base CVSS score
        if "credential" in vuln_type.lower() or "API_KEY" in str(detected_patterns):
            score = VulnerabilityScore(
                attack_vector=AttackVector.NETWORK,
                attack_complexity=AttackComplexity.LOW,
                privileges_required=PrivilegesRequired.NONE,
                user_interaction=UserInteraction.NONE,
                scope=Scope.CHANGED,
                confidentiality=Impact.HIGH,
                integrity=Impact.HIGH,
                availability=Impact.LOW
            )
        elif "embedding" in vuln_type.lower():
            score = VulnerabilityScore(
                attack_vector=AttackVector.NETWORK,
                attack_complexity=AttackComplexity.LOW,
                privileges_required=PrivilegesRequired.NONE,
                user_interaction=UserInteraction.NONE,
                scope=Scope.CHANGED,
                confidentiality=Impact.LOW,
                integrity=Impact.HIGH,
                availability=Impact.LOW
            )
        else:
            score = VulnerabilityScore(
                attack_vector=AttackVector.NETWORK,
                attack_complexity=AttackComplexity.LOW,
                privileges_required=PrivilegesRequired.LOW,
                user_interaction=UserInteraction.NONE,
                scope=Scope.UNCHANGED,
                confidentiality=Impact.LOW,
                integrity=Impact.HIGH,
                availability=Impact.LOW
            )
        
        base_score = score.calculate_base_score()
        multiplier = self.RAG_MULTIPLIERS.get(vuln_type, 1.0)
        final_score = min(base_score * multiplier, 10.0)
        
        return {
            "vulnerability_type": vuln_type,
            "cvss_base_score": base_score,
            "rag_multiplier": multiplier,
            "final_score": round(final_score, 1),
            "severity": score.get_severity(),
            "detected_patterns": detected_patterns,
            "vector_string": self._generate_vector_string(score)
        }
    
    def _generate_vector_string(self, score: VulnerabilityScore) -> str:
        """Generate CVSS vector string"""
        return (f"CVSS:3.1/AV:{score.attack_vector.value[0]}/"
                f"AC:{score.attack_complexity.value[0]}/"
                f"PR:{score.privileges_required.value[0]}/"
                f"UI:{score.user_interaction.value[0]}/"
                f"S:{score.scope.value[0]}/"
                f"C:{score.confidentiality.value[0]}/"
                f"I:{score.integrity.value[0]}/"
                f"A:{score.availability.value[0]}")

# Example usage
if __name__ == "__main__":
    scorer = RAGVulnerabilityScorer()
    
    vuln = scorer.score_vulnerability(
        "credential_leakage",
        ["API_KEY=sk-proj-xxx", "AWS_SECRET"]
    )
    
    print(json.dumps(vuln, indent=2))
